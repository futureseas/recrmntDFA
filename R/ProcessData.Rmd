---
title: "Recruitment DFA data processing"
author: "Robert Wildermuth"
date: "2023-03-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

library(tidyverse)
library(MARSS)
library(lubridate)
library(sf)
library(stars)
library(cubelyr)
library(r4ss)
```

# California Current Integrated Ecosystem Assessment data
Data were downloaded from the [CalCurrent IEA website](https://www.integratedecosystemassessment.noaa.gov/regions/california-current/california-current-iea-indicators) 1/9/2023. Monthly or seasonal values were aggregated across relevant time periods for fish life histories to create annual values for the DFA.
```{r}
# get data files to read in and collate

# data file path
datPath <- "C:/Users/r.wildermuth/Documents/FutureSeas/RecruitmentIndex/DFA_data/"
# handle weights, habitat, and zooplankton separately
datFiles <- list.files(datPath)
datFiles <- datFiles[-which(datFiles %in% c("Anchovy_Sardine_len_wt_age.csv", 
                                              "AtlantisModel_C_biomass_data_31Mar2021.csv",
                                              "SDMoutput",
                                            "anchovySSfiles",
                                            "SpringPRPOOSdata_Copepods_sizeFractions.csv",
                                            "SpringPRPOOSdata_Nauplii_sizeFractions.csv"))]

# df names
datNames <- sub("_dl20230109.csv", "", datFiles)
datNames <- sub("cciea_", "", datNames)

# -------- Create table mapping variable names to descriptions and sources -----
datDict <- data.frame(Variable = datNames,
                      Description = c("Habitat compression index",
                                      "Northern copepod biomass anomaly at 44.6N",
                                      "Southern copepod biomass anomaly at 44.6N",
                                      "Biologically Effective Upwelling Transport Index at 33N",
                                      "Biologically Effective Upwelling Transport Index at 39N",
                                      "Length of Upwelling Season Index at 33N",
                                      "Length of Upwelling Season Index at 36N",
                                      "Length of Upwelling Season Index at 39N",
                                      "Multivariate El Nino Southern Oscillation Index",
                                      "Northern Oscillation Index",
                                      "North Pacific Gyre Oscillation Index",
                                      "Pacific Decadal Oscillation Index",
                                      "Spring Transition Index at 33N",
                                      "Spring Transition Index at 36N",
                                      "Spring Transition Index at 39N",
                                      "Total spring CalCOFI larval anchovy (ln(n+1)/10m^2)",
                                      "Total spring CalCOFI larval sardine (ln(n+1)/10m^2)",
                                      "Total spring CalCOFI larval southern mesopelagics (ln(n+1)/10m^2)",
                                      "Mean myctophids in SWFSC Rockfish Recruitment & Ecosystem Assessment Survey (log(CPUE+1))"),
                      Source = "CCIEA")
datDict

for(i in 1:length(datFiles)) {
  assign(datNames[i],
         read_csv(paste0(datPath,
                          datFiles[i]),
                  col_names = c("time", datNames[i]),
                  col_types = c("T","d"),
                  skip = 2))
}

# creates 'year' and 'month' columns 
recrDat <- lapply(mget(datNames), 
                  function(x) {x %>% mutate(year = year(time),
                                            month = month(time)) %>%
                                  select(-time)})

# ---- Aggregate monthly measures for annual time series ------
# NPGO indicator of forage, aggregate May - July
recrDat$OC_NPGO <- recrDat$OC_NPGO %>% filter(month %in% 5:7) %>%
                      group_by(year) %>%
                      summarize(NPGO = mean(OC_NPGO))

# PDO indicator of preconditioning, aggregate March - July, Aug - Oct
recrDat$OC_PDO <- recrDat$OC_PDO %>% filter(month %in% 3:10) %>%
                      mutate(seas = case_when(month %in% 3:7 ~ "spring",
                                              month %in% 8:10 ~ "summer")) %>%
                      group_by(year, seas) %>%
                      summarize(PDO = mean(OC_PDO)) %>% 
                      pivot_wider(names_from = seas, names_prefix = "PDO",
                                  values_from = PDO)

# NOI indicator of forage, aggregate March - July
recrDat$OC_NOI <- recrDat$OC_NOI %>% filter(month %in% 3:7) %>%
                      group_by(year) %>%
                      summarize(NOI = mean(OC_NOI))

# ENSO indicator of forage, aggregate March - July
recrDat$OC_MultiENSOindx <- recrDat$OC_MultiENSOindx %>% filter(month %in% 3:7) %>%
                              group_by(year) %>%
                              summarize(ENSO = mean(OC_MultiENSOindx))

# BEUTI indicator of forage, aggregate May - July
recrDat$OC_BEUTI_33N <- recrDat$OC_BEUTI_33N %>% filter(month %in% 5:7) %>%
                          group_by(year) %>%
                          summarize(BEUTI_33N = mean(OC_BEUTI_33N))
recrDat$OC_BEUTI_39N <- recrDat$OC_BEUTI_39N %>% filter(month %in% 5:7) %>%
                          group_by(year) %>%
                          summarize(BEUTI_39N = mean(OC_BEUTI_39N))

# HCI indicator of preconditioning, aggregate March - July
recrDat$EI_HCI <- recrDat$EI_HCI %>% filter(month %in% 3:7) %>%
                              group_by(year) %>%
                              summarize(HCI = mean(EI_HCI))

# COPepod community indicator of preconditioning and forage, aggregate March - July, Aug - Oct
recrDat$EI_NorthernCOP_44.6N <- recrDat$EI_NorthernCOP_44.6N %>% filter(month %in% 3:10) %>%
                      mutate(seas = case_when(month %in% 3:7 ~ "spring",
                                              month %in% 8:10 ~ "summer")) %>%
                      group_by(year, seas) %>%
                      summarize(NCOP = mean(EI_NorthernCOP_44.6N)) %>% 
                      pivot_wider(names_from = seas, names_prefix = "NCOP",
                                  values_from = NCOP)

recrDat$EI_SouthernCOP_44.6N <- recrDat$EI_SouthernCOP_44.6N %>% filter(month %in% 3:10) %>%
                      mutate(seas = case_when(month %in% 3:7 ~ "spring",
                                              month %in% 8:10 ~ "summer")) %>%
                      group_by(year, seas) %>%
                      summarize(SCOP = mean(EI_SouthernCOP_44.6N)) %>% 
                      pivot_wider(names_from = seas, names_prefix = "SCOP",
                                  values_from = SCOP)

# collapses dfs into single wide table
recrDat <- recrDat %>% reduce(full_join, by = "year") 
recrDat <- recrDat %>% select(-starts_with("month", vars = names(recrDat))) %>%
              arrange(year)

recrDat %>% pivot_longer(cols = c(-year), names_to = "Index", values_to = "vals") %>%
  filter(!is.na(vals), year >= 1950, year != 2020) %>%
  ggplot(aes(x = year, y = vals)) +
  geom_line() +
  facet_wrap(~Index, scales = "free_y") +
  theme_classic()
```

# Weight-at-age data
```{r}
# From Yuhong Gu (3/21/2023): columns(cruise, ship, haul, species, and specimen) is a unique fish identifier, some fish has multiple readers.
waa <- read_csv(file = paste0(datPath, "Anchovy_Sardine_len_wt_age.csv"), na = "NULL")

waa <- waa %>% select(equilibriumTime, species, commonName, weightg, age) %>% 
          mutate(equilibriumTime = ymd_hms(equilibriumTime),
                 year = year(equilibriumTime), month = month(equilibriumTime),
                 seas = case_when(month %in% 1:6 ~ "spring",
                                  month %in% 7:12 ~ "summer")) %>%
          group_by(year, seas, age, commonName) %>%
          summarize(avgWAA = mean(weightg, na.rm = TRUE))

waa %>% filter(age == 1) %>%
  ggplot(aes(x = year, y = avgWAA, color = seas)) +
  geom_line() +
  facet_wrap(~commonName, scales = "free_y") +
  labs(y = "Avg weight of Age 1 fish (g)")

waa %>% group_by(commonName, year, seas) %>%
  summarize(meanWt = mean(avgWAA, na.rm = TRUE)) %>%
  ggplot(aes(x = year, y = meanWt, color = seas)) +
  geom_line() +
  facet_wrap(~commonName, scales = "free_y") +
  labs(y = "Mean weight (g)")

# WAA from fishery data used in SS
# From Charlie Hinchliff on 4/4/2023:
# The model is based on a June-May biological year (aka ‘model year’), with two 
# semester-based seasons (5 & 7 months) per year (S1 is Jun-Dec, and S2 is Jan-May).
# and:
# for 'model year' S2 will actually correspond to the following calendar year 
# i.e., fish in 'model year-season' 2015-2 were caught at the beginning of 2016 (Jan-May).
# This will be the same for biomass output too.
waaFishery <- read_csv(paste0(datPath,
                              "anchovySSfiles/anchovy_formatted_wtatage_for_Robert.csv"))

waaFishery %>% ggplot(aes(x = modelyear, y = a1, color = as.character(Seas))) +
  geom_line() +
  # facet_wrap(~commonName, scales = "free_y") +
  labs(y = "Mean weight (g)")
```
# Zooplankton data
```{r}
zooplkn <- read_csv(file= paste0(datPath, "AtlantisModel_C_biomass_data_31Mar2021.csv"),
                    na = "NaN")

zooplkn <- zooplkn %>% mutate(Time = mdy_hm(Time),
                              year = year(Time), month = month(Time),
                              seas = case_when(month %in% 1:6 ~ "spring",
                                               month %in% 7:12 ~ "summer")) %>%
              filter(!is.na(year))

# adding Atlantis groupings from Pierre-Yves definitions
zooplkn <- zooplkn %>%
              mutate(atlGrp = case_when(Class %in% c("salps","pyrosomes",
                                                     "ctenophora", "cnidaria") ~ "Gelatinous",
                             Class %in% c("polychaete","crustacea_others",
                                          "chaetognatha","appendicularia",
                                          "euphausiids") ~ "Large zooplankton",
                             Class %in% c("pteropoda") ~ "Pteropods",
                             Class %in% c("radiolarians","foraminifera") ~ "Microzooplankton",
                             Class %in% c("all_calanoid_copepods","All_Copepods",
                                          "doliolids","ostracods", "nauplii") ~ "Mesozooplankton",
                             Class %in% c("eggs","others","bryozoan_larvae") ~ "Others",
                             TRUE ~ "NA"))

# Plot copepods, nauplii, eggs and euphausiids over time
zooplkn %>% group_by(Class, year, seas) %>%
  summarize(meanZooplkn = mean(`Carbon Biomass Sum (mgC m-2)`)) %>%
  filter(Class %in% c("all_calanoid_copepods","All_Copepods", "nauplii",
                      "eggs", "euphausiids")) %>%
  ggplot(aes(x = year, y = meanZooplkn, color = seas)) +
  geom_line() +
  facet_wrap(~Class, scales = "free_y")
```
Size fraction data for nauplii and copepods
```{r}
copepodSize <- read_csv(file= paste0(datPath, "SpringPRPOOSdata_Copepods_sizeFractions.csv"),
                    na = "NaN")
copepodSize <- copepodSize %>% mutate(Time_PST = dmy_hms(Time_PST),
                                      year = year(Time_PST), month = month(Time_PST)) %>%
                  filter(!is.na(year),
                         Night0Day1 == 1) # larvae only forage during day

# need to get total biomass C per year
copTotBio <- copepodSize %>% group_by(year) %>%
              summarize(totBio = sum(Carbon_mg_sum))

copMeanSize <- copepodSize %>% 
                  mutate(size = str_match(string = `Size Range (Major Axis)`, pattern = "-\\s*(.*?)\\s*mm")[,2],
                         size = as.numeric(size),
                         numProd = size * ugcarbon_n) %>%
                  group_by(year, `Size Range (Major Axis)`, size) %>%
                  summarize(totSize = sum(ugcarbon_n),
                            copMeanSize = sum(numProd),
                            copBioSize = sum(Carbon_mg_sum)) %>%
                  full_join(y = copTotBio, by = "year") %>% 
                  mutate(copPropBioSize = (copBioSize/totBio)*(size-0.25)) %>%
                  group_by(year) %>%
                  summarize(totSize = sum(totSize),
                            copMeanSize = sum(copMeanSize),
                            copPropBioSize = sum(copPropBioSize)) %>%
                  mutate(copMeanSize = copMeanSize/totSize)

copMeanSize %>% ggplot(aes(x = year, y = copMeanSize)) +
  geom_line() +
  labs(y = "Mean copepod size in spring (mm)")

# -- nauplii
naupliiSize <- read_csv(file= paste0(datPath, "SpringPRPOOSdata_Nauplii_sizeFractions.csv"),
                    na = "NaN")
naupliiSize <- naupliiSize %>% mutate(Time_PST = dmy_hms(Time_PST),
                                      year = year(Time_PST), month = month(Time_PST)) %>%
                  filter(!is.na(year))

# need to get total biomass C per year
naupTotBio <- naupliiSize %>% group_by(year) %>%
              summarize(totBio = sum(Carbon_mg_sum))

naupMeanSize <- naupliiSize %>% 
                  mutate(size = str_match(string = `Size Range (Major Axis)`, pattern = "-\\s*(.*?)\\s*mm")[,2],
                         size = as.numeric(size),
                         numProd = size * ugcarbon_n) %>%
                  group_by(year, `Size Range (Major Axis)`, size) %>%
                  summarize(totSize = sum(ugcarbon_n),
                            naupMeanSize = sum(numProd),
                            naupBioSize = sum(Carbon_mg_sum)) %>%
                  full_join(y = naupTotBio, by = "year") %>% 
                  mutate(naupPropBioSize = (naupBioSize/totBio)*(size-0.25)) %>%
                  group_by(year) %>%
                  summarize(totSize = sum(totSize),
                            naupMeanSize = sum(naupMeanSize),
                            naupPropBioSize = sum(naupPropBioSize)) %>%
                  mutate(naupMeanSize = naupMeanSize/totSize)

naupMeanSize %>% ggplot(aes(x = year, y = naupMeanSize)) +
  geom_line() +
  labs(y = "Mean nauplii size in spring (mm)")
```

# Species distribution model outputs
Spawning habitat area and duration are calculated from ROMS-based species distribution models produced by Barb Muhling and downloaded 3/29/2023. Habitat predictions are derived from SDMs without SSB included as a predictor. For now using only GAM estimates of SDM.

From conversation with Barb on 3/29/23:
- ROMS-based estimates have more predictors, thus better predictions of habitat
- ROMS sample frame likely represents northern Pacific sardine stock better
- ROMS predictions need updates before final version of analysis

## Spawning habitat area
A proxy of area of spawning habitat is determined by compiling daily habitat estimates across years within the traditional breeding season (for sardine: March - July). Breeding habitat is defined as SDM cells with probabilities of occurrence at or above the upper 95% confidence interval. The annual index is calculated as the sum of probabilities of occurrence in breeding habitat over all cells and days within the traditional breeding season for each year.

```{r}
# sardine and anchovy have different breeding seasons
sardFiles <- expand.grid("sard", 3:7, 1998:2018, "GAM_noSSB.nc") %>% 
                    mutate(sdmFile = paste(Var1, Var2, Var3, Var4, sep = "_")) %>%
                    pull(sdmFile)

sardFiles <- paste0(datPath, "SDMoutput/sardine_noSSB/", sardFiles)
sardSDMs <- read_stars(sardFiles, proxy = FALSE, quiet = TRUE)
st_crs(sardSDMs) <- "+proj=longlat +ellps=WGS84 +datum=WGS84"
sardSDMs <- st_transform(sardSDMs, "+proj=longlat +ellps=WGS84 +datum=WGS84")
#st_get_dimension_values(sardSDMs, "time")

# Use CalCurrent Atlantis extent to limit sample frame
ccAtl <- st_read("C:/Users/r.wildermuth/Documents/FutureSeas/MapFiles/emocc_whole_domain.shp")
ccAtl <- st_transform(ccAtl, "+proj=longlat +ellps=WGS84 +datum=WGS84")

# restrict to area south of 40deg N
newAtlbbox <- st_bbox(ccAtl)
newAtlbbox$ymax <- 40.0
newAtlbbox <- st_bbox(unlist(newAtlbbox))
ccAtl <- st_crop(ccAtl, newAtlbbox)

# crop to Atlantis extent
sardSDMs <- st_crop(x = sardSDMs,
                      y = ccAtl)

# show first 5 days of SDM
sardSlice <- slice(sardSDMs, index = 1:5, along = "time")
ggplot() + geom_stars(data = sardSlice) + facet_wrap(~time)

# Calculate high probability habitat
probMean <- mean(sardSDMs$sard_3_1998_GAM_noSSB.nc, na.rm = TRUE)
probSD <- sd(sardSDMs$sard_3_1998_GAM_noSSB.nc, na.rm = TRUE)
upper95 <- probMean + 1.96*probSD
# discrimination threshold from Barb Muhling:
sardHabThresh <- 0.42

# Try masking low probability cells
sardSpawn <- sardSDMs
sardSpawn[sardSDMs < sardHabThresh] <- NA
# Don't allow spawning habitat above 40deg north
#sardSpawn2 <- sardSpawn %>% filter(y < 40)

sardSpawnSlice <- slice(sardSpawn, index = 150:160, along = "time")
#ggplot() + geom_stars(data = sardSpawnSlice) + facet_wrap(~time)

# Map prep
pac.coast <- borders("world", colour="gray50", fill="gray50", xlim = c(-140, -100), ylim = c(20, 60))
mycols <- colors()[c(473,562,71,610,655,653,621,34)]
mypalette <- colorRampPalette(mycols)(255)

ggplot() +
  geom_stars(data = sardSpawnSlice) +
  scale_fill_gradientn(colours = mypalette, limits = c(0, 0.8), na.value = NA) +
  guides(fill = guide_colorbar(barwidth=0.5, barheight=5)) +
  pac.coast + 
  geom_sf(data = ccAtl, color = "black", size = 1.5, fill = NA) +
  coord_sf(xlim = c(-130, -113), ylim = c(27, 42)) +
  facet_wrap(~time)

sardSpawnYr <- aggregate(sardSpawn, by = "years", FUN = sum, na.rm = TRUE)
st_get_dimension_values(sardSpawnYr, "time")

ggplot() +
  geom_stars(data = aperm(sardSpawnYr, c(2,3,1))) +
  scale_fill_gradientn(colours = mypalette,
                       limits = c(0, max(sardSpawnYr$sard_3_1998_GAM_noSSB.nc,
                                         na.rm = TRUE)),
                       na.value = NA) +
  guides(fill = guide_colorbar(barwidth=0.5, barheight=5)) +
  pac.coast +
  geom_sf(data = ccAtl, color = "black", size = 1.5, fill = NA) +
  coord_sf(xlim = c(-130, -115), ylim = c(28, 42)) +
  facet_wrap(~time)

sardSpawnHab <- aggregate(sardSpawnYr, ccAtl, FUN = sum, na.rm = TRUE)

#--- Anchovy --------------------------
anchFiles <- expand.grid("anch", 2:4, 1998:2018, "GAM_noSSB.nc") %>% 
                    mutate(sdmFile = paste(Var1, Var2, Var3, Var4, sep = "_")) %>%
                    pull(sdmFile)

anchFiles <- paste0(datPath, "SDMoutput/anchovy_noSSB/", anchFiles)
anchSDMs <- read_stars(anchFiles, proxy = FALSE, quiet = TRUE)
st_crs(anchSDMs) <- "+proj=longlat +ellps=WGS84 +datum=WGS84"
anchSDMs <- st_transform(anchSDMs, "+proj=longlat +ellps=WGS84 +datum=WGS84")
#st_get_dimension_values(anchSDMs, "time")

# crop to Atlantis extent
anchSDMs <- st_crop(x = anchSDMs,
                      y = ccAtl)

# show first 5 days of SDM
anchSlice <- slice(anchSDMs, index = 1:5, along = "time")
ggplot() + geom_stars(data = anchSlice) + facet_wrap(~time)

# Calculate high probability habitat
probMean <- mean(anchSDMs$anch_2_1998_GAM_noSSB.nc, na.rm = TRUE)
probSD <- sd(anchSDMs$anch_2_1998_GAM_noSSB.nc, na.rm = TRUE)
upper95 <- probMean + 1.96*probSD
# discrimination threshold from Barb Muhling:
anchHabThresh <- 0.30

# Try masking low probability cells
anchSpawn <- anchSDMs
anchSpawn[anchSDMs < anchHabThresh] <- NA

anchSpawnSlice <- slice(anchSpawn, index = 150:160, along = "time")
#ggplot() + geom_stars(data = sardSpawnSlice) + facet_wrap(~time)

ggplot() +
  geom_stars(data = anchSpawnSlice) +
  scale_fill_gradientn(colours = mypalette, limits = c(0, 0.8), na.value = NA) +
  guides(fill = guide_colorbar(barwidth=0.5, barheight=5)) +
  pac.coast + 
  geom_sf(data = ccAtl, color = "black", size = 1.5, fill = NA) +
  coord_sf(xlim = c(-130, -113), ylim = c(27, 42)) +
  facet_wrap(~time)

anchSpawnYr <- aggregate(anchSpawn, by = "years", FUN = sum, na.rm = TRUE)
st_get_dimension_values(anchSpawnYr, "time")

ggplot() +
  geom_stars(data = aperm(anchSpawnYr, c(2,3,1))) +
  scale_fill_gradientn(colours = mypalette,
                       limits = c(0, max(anchSpawnYr$anch_2_1998_GAM_noSSB.nc,
                                         na.rm = TRUE)),
                       na.value = NA) +
  guides(fill = guide_colorbar(barwidth=0.5, barheight=5)) +
  pac.coast +
  geom_sf(data = ccAtl, color = "black", size = 1.5, fill = NA) +
  coord_sf(xlim = c(-130, -115), ylim = c(28, 42)) +
  facet_wrap(~time)

anchSpawnHab <- aggregate(anchSpawnYr, ccAtl, FUN = sum, na.rm = TRUE)
spawnTS <- data.frame(year = 1998:2018,
                      sardSpawnHab = t(sardSpawnHab$sard_3_1998_GAM_noSSB.nc),
                      anchSpawnHab = t(anchSpawnHab$anch_2_1998_GAM_noSSB.nc))

spawnTS %>% pivot_longer(cols = c("sardSpawnHab", "anchSpawnHab")) %>%
  ggplot() +
  geom_line(aes(x = year, y = value, col = name))
```

## Spawning season timing and duration
Two options for spawning timing:
1. Hierarchical process of determining spawning area from yearly maps using rules for spawning area to create possible spawning area polygon, then indicating date at which some threshold of cells reach breeding habitat probability threshold within that area.
2. Similar to 1), but using polygon derived from CalCOFI stations with high proportion of larval catches throughout the survey.

# Assessment biomass and recruitment
Use Stock Synthesis-based estimates of biomass and recruitment as index variables
```{r}
# sardine - use r4ss package to read in from research model folder
sardVals <- SS_output("C:/Users/r.wildermuth/Documents/FutureSeas/sardine_research_assessment",
                      verbose = FALSE, printstats = FALSE)

sardBio <- sardVals$timeseries %>% filter(Era == "TIME") %>%
              # account for model year + S2 = next calendar year
              mutate(Yr = as.numeric(Yr),
                     year = case_when(Seas == 2 ~ Yr + 1,
                                      TRUE ~ Yr)) %>%
              select(year, Seas, Bio_smry) %>% 
              pivot_wider(names_from = Seas, names_prefix = "sardBioSmrySeas",
                          values_from = Bio_smry)

sardRec <- sardVals$recruit %>% filter(era == "Main") %>%
              select(Yr, dev) %>%
              rename(sardRec = dev)

sardBio %>% ggplot(aes(x = year, y = sardBioSmrySeas1)) +
  geom_line()

sardRec %>% ggplot(aes(x = Yr, y = sardRec)) +
  geom_line()

# anchovy
anchBio <- read_csv(paste0(datPath, "anchovySSfiles/anchovy_bio_timeseries_data_for_Robert.csv"))
anchBio <- anchBio %>% filter(Era == "TIME") %>%
              # account for model year + S2 = next calendar year
              mutate(year = case_when(Seas == 2 ~ Yr + 1,
                                      TRUE ~ Yr)) %>%
              select(year, Seas, Bio_smry) %>% 
              pivot_wider(names_from = Seas, names_prefix = "anchBioSmrySeas",
                          values_from = Bio_smry)

anchRec <- read_csv(paste0(datPath, "anchovySSfiles/anchovy_rec_data_for_Robert.csv"))
anchRec <- anchRec %>% filter(era == "Main") %>%
              select(Yr, dev) %>%
              rename(anchRec = dev)

anchBio %>% ggplot(aes(x = year, y = anchBioSmrySeas2)) +
  geom_line()

anchRec %>% ggplot(aes(x = Yr, y = anchRec)) +
  geom_line()
```

```{r}
# compile and save data for analysis

# only spring sardine have decent number of observations
waa <- waa %>% filter(age == 1, seas == "spring", 
                      commonName == "Pacific sardine (pilchard)") %>%
          rename(age1SprSardmeanWAA = avgWAA) %>% ungroup() %>%
          select(year, age1SprSardmeanWAA)
# Use observed fishery-dependent waa for anchovy
# Note: gap in observations between 1988-2013, so may only be useful for longer-term analysis in STAN
waaFishery <- waaFishery %>% filter(Seas == 2) %>%
                # account for model year + S2 being in next calendar year
                mutate(year = modelyear + 1) %>%
                select(year, a1) %>%
                rename(age1SprAnchmeanWAA = a1)

# take only small zooplkn groups in spring for larvae forage
zooplkn <- zooplkn %>% group_by(Class, year, seas) %>%
              summarize(meanZooplkn = mean(`Carbon Biomass Sum (mgC m-2)`)) %>%
              filter(Class %in% c("all_calanoid_copepods","All_Copepods", 
                                  "nauplii", "eggs", "euphausiids"),
                     seas == "spring") %>%
              pivot_wider(names_from = Class, values_from = meanZooplkn) %>%
              select(-seas)

# zooplkn size spectra
copMeanSize <- copMeanSize %>% select(-totSize)
naupMeanSize <- naupMeanSize %>% select(-totSize)

# Join SS output and change name of 'Yr' once
outSS3 <- anchRec %>% full_join(sardRec, by = "Yr")  %>% 
            rename(year = Yr)

# Combine everything together and save
recrDat <- recrDat %>% full_join(waa, by = "year") %>%
              full_join(waaFishery, by = "year") %>%
              full_join(zooplkn, by = "year") %>%
              full_join(copMeanSize, by = "year") %>%
              full_join(naupMeanSize, by = "year") %>%
              full_join(spawnTS, by = "year") %>%
              full_join(outSS3, by = "year") %>%
              full_join(anchBio, by = "year") %>%
              full_join(sardBio, by = "year")

write_csv(recrDat, file = "C:/Users/r.wildermuth/Documents/FutureSeas/RecruitmentIndex/recrmntDFA/recrDFAdat.csv")
```